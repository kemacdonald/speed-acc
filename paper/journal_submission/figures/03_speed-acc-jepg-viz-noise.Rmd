---
title: "Speed-Acc JEP: General Figure Visualization Code (Noise)"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=3, fig.height=3, fig.crop = F, fig.pos = "tb",
                      fig.path='figs/',echo=F, warning=F, cache=T, message=F, include =F,
                      sanitize = T)
```

# Set up 

This document contains the codebase for generating the plots for Study 3 in the paper, "An information-seeking account of children's eye movements during grounded signed and spoken language comprehension"

```{r load libraries}
library(here); library(kableExtra); library(rogme); library(ggridges); library(ggrepel)
source(here::here("R/helper_functions/libraries_and_functions.R"))
source(here::here("R/helper_functions/ewma_helper_funs.R"))
```

```{r set data paths}
data_path <- "data/3_final_merged_data/first_shifts/"
time_path <- "data/3_final_merged_data/timecourse/"
models_path <- "data/3_final_merged_data/bda_posterior_samples/"
ewma_path <- "data/3_final_merged_data/ewma_output/"
hddm_path <- "data/3_final_merged_data/hddm_output/"
```

```{r read data}
d_kids_noise <- read_csv(here::here(data_path, "speed_acc_child_noise_fstshift_tidy.csv")) %>% 
  select(-age)

d_adults <- read_csv(here::here(data_path, "speed_acc_adult_ng_fstshift_tidy.csv")) %>% 
  select(-age)

# merge datasets
d <- bind_rows(mutate(d_kids_noise, experiment = "kids_noise", age_category = "children"),
               mutate(d_adults, experiment = "adults_ng", age_category = "adults")) %>% 
  select(-resp_onset_type_fact, -subid_short) %>% 
  mutate(age_category = factor(age_category) %>% fct_rev(),
         gaze_condition = factor(gaze_condition) %>% fct_rev()) 

# test that we have the right number of rows after the merge (result should be TRUE)
nrow(d_kids_noise) + nrow(d_adults) == nrow(d)
```

```{r read timecourse}
d_timecourse_adults <- read_csv(here::here(time_path, "speed_acc_adult_ng_timecourse_tidy.csv.gz"))
d_timecourse_adults %<>% mutate(age_code = "adults")

d_timecourse_kids <- read_csv(here::here(time_path, "speed_acc_child_noise_timecourse_tidy.csv.gz"))
d_timecourse_kids %<>% mutate(age_code = "children")

d_timecourse <- bind_rows(d_timecourse_adults, d_timecourse_kids)
```

```{r read bda}
d_bda_noise <- readRDS(here::here(models_path, "speed-acc-noise-posterior-samples.rds"))
d_bda_ewma_noise <- readRDS(here::here(models_path, "speed-acc-noise-ewma-guess-posterior-samples.rds"))
```

# Plots for speech in background noise experiment

### Timecourse plots

Select plotting window and downsample the t.rel.noun time bins based on the sampling rate of the tracker. 

```{r}
samp_rate <- 30

d_time_filt <- d_timecourse %>% 
  filter(t.stim > 0, t.stim <= 9) %>% 
  filter(t.rel.noun >= 0, t.rel.noun <= 2.5) 

d_time_filt %<>% mutate(t.rel.noun = round(t.rel.noun * samp_rate) / samp_rate)
```

Summarise proportion looking at the participant level.

```{r}
# get number of trials looking at each gaze target for each time slice
ss.d <- d_time_filt %>% 
  group_by(subid, t.rel.noun, noise_condition, age_code) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  complete(nesting(subid, t.rel.noun, age_code), noise_condition,
           fill = list(count = 0)) %>% 
  mutate(subid = as.character(subid))

# get proportion looking by dividing the freq looking at each target by the total looking 
# derived in step 1 of this chunk
ss.d <- as.data.frame(xtabs(~ subid + t.rel.noun + target_looking + noise_condition + age_code, 
                            data = d_time_filt),
                      stringsAsFactors = F) %>% 
  mutate(t.rel.noun = as.numeric(t.rel.noun)) %>% 
  left_join(x = ss.d, y = ., by = c("subid", "t.rel.noun", "noise_condition", "age_code")) %>% 
  mutate(proportion_looking = Freq / count)
```

Summarise at the age group and condition level by computing means and bootsrapped CIs for each timepoint.

```{r, eval = F}
# nboot should be 500
nboot <- 500

ms_mean_iChart <- ss.d %>% 
  group_by(t.rel.noun, noise_condition, target_looking, age_code) %>% 
  langcog::multi_boot_standard(column = "proportion_looking", na.rm = T, nboot = nboot) %>% 
  filter(is.na(noise_condition) == F) 

write_csv(x = ms_mean_iChart, 
          path = here::here("paper/journal_submission/figures/noise_timecourse_graph_vals.csv"))
```

Make the timecourse plot.

```{r}
noise_time_gvs <- read_csv(here::here("paper/journal_submission/figures/noise_timecourse_graph_vals.csv"))

noise_time_gvs %<>% 
  filter(t.rel.noun <= 2.4, !(is.na(mean))) %>% 
  mutate(age_code = fct_relevel(age_code, "children", "adults"))

noise_timecourse_plot <- ggplot(aes(x = as.numeric(t.rel.noun), 
                                    y = mean, 
                                    color = noise_condition,
                                    linetype = target_looking), 
                                data = noise_time_gvs) + 
  geom_line(size = 1) +
  geom_linerange(aes(ymin = summary_ci_lower, ymax = summary_ci_upper), alpha = 0.5) +
  xlab("Time from noun onset (sec)") +
  ylab("Proportion looking") +
  guides(linetype = F) +
  facet_wrap(~age_code, ncol = 1) +
  ggthemes::scale_color_ptol() +
  geom_text_repel(
    data = filter(noise_time_gvs, t.rel.noun == max(t.rel.noun), 
                  noise_condition == "clear"),
    aes(label = target_looking),
    color = "grey40",
    size = 4,
    nudge_x = .25,
    segment.color = NA
  ) +
  lims(x = c(0, 2.6), 
       y = c(-.01,1)) +
  theme(plot.margin = unit(c(1,4,1,1), "lines"),
        legend.position = c(0.85, 0.9)) 


noise_timecourse_plot
```

### First shifts plots

```{r filter noise experiment}
d_fst <- d %>% 
  filter(keep_runsheet %in% c("yes", "keep"), 
         keep_et == "include") %>% 
  filter(rt <= 1.5,
         response_onset_type == "noun",
         shift_start_location == "center") %>% 
  mutate(shift_acc_num = ifelse(shift_accuracy_clean == "correct", 1, 0),
         log_rt = log(rt))
```

Aggregate for accuracy and RT

```{r}
ss <- d_fst %>% 
  mutate(correct_num = ifelse(shift_accuracy == "correct", 1, 0)) %>% 
  group_by(noise_condition, subid, age_category) %>% 
  summarise(m_rt = median(rt),
            m_acc = mean(correct_num))
```

Make first shift accuracy plot.

```{r set global plot values}
pt_size <- 2.2
pt_alpha <- 0.6
pt_shape <- 21
pt_width <- 0.15
pt_color <- "black"
pt_fill <- "darkgrey"
nboot <- 500
```

```{r make noise acc plot}
p_acc <- ss %>% 
  filter(m_acc > 0) %>% 
  ggplot(aes(x = fct_relevel(noise_condition, "noise", after = 2), 
             y = m_acc)) +
  ggbeeswarm::geom_quasirandom(shape = pt_shape, 
                               width = pt_width, 
                               color = pt_color, 
                               size = pt_size,
                               fill = pt_fill,
                               alpha = pt_alpha) + 
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  labs(x = NULL, y = "Prop. Correct") +
  lims(y = c(0, 1)) +
  facet_wrap(~age_category, ncol = 1)

# get model values
ms_acc_e1 <- d_bda_noise$acc_noise %>% 
  group_by(noise_condition, age_category) %>% 
  summarise(m_acc = mean(acc_prob_scale),
            hdi_lower = quantile(acc_prob_scale, probs = 0.025),
            hdi_upper = quantile(acc_prob_scale, probs = 0.975)) %>% 
  mutate_if(.predicate = is.numeric, .funs = round, digits = 2) %>% 
  mutate(age_category = factor(age_category) %>% fct_rev()) 

# add quantiles to plot
p_acc <- p_acc +
  geom_pointrange(aes(ymax = hdi_upper, ymin = hdi_lower), 
                  data = ms_acc_e1,
                  color = "red",
                  shape = 15,
                  size = 0.7)


# get pairwise diffs
diffs_df <- ss %>% 
  select(m_acc, subid, noise_condition, age_category) %>% 
  spread(noise_condition, m_acc) %>% 
  group_by(age_category) %>% 
  mutate(diff = noise - clear) 

ms_diffs <- diffs_df %>% 
  group_by(age_category) %>% 
  langcog::multi_boot_standard(column = "diff", na.rm = T, nboot = nboot) %>% 
  rename(diff = mean)

# now plot those differs
pairwise_diffs_plot <- diffs_df %>% 
  mutate(title = "Pairwise contrast") %>%  # hack to get plots to line up nicely
  ggplot(aes(x = fct_rev(age_category), y = diff)) +
  geom_jitter(shape = pt_shape, 
              width = 0.1, 
              color = pt_color, 
              size = pt_size,
              fill = pt_fill,
              alpha = pt_alpha) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_pointrange(aes(ymin = summary_ci_lower, ymax = summary_ci_upper), 
                  data = ms_diffs,
                  shape = 15,
                  size = 0.7,
                  color = "red") +
  ylim(-0.45, 0.7) +
  labs(x = NULL, y = "Prop. correct difference") +
  coord_flip() +
  facet_wrap(~title)

# put plots together
p_acc <- plot_grid(p_acc, pairwise_diffs_plot, ncol = 2, rel_widths = c(0.8, 1),
                   scale = c(1, 0.8))
```

Make RT plot

```{r make text rt plot}
p_rt <- ss %>% 
  ggplot(aes(x = fct_reorder(noise_condition, m_rt, .fun = median), y = m_rt)) +
  ggbeeswarm::geom_quasirandom(shape = pt_shape, 
                               width = pt_width + 0.1, 
                               color = pt_color, 
                               size = pt_size,
                               fill = pt_fill,
                               alpha = pt_alpha) +  
  ylim(0, 1.3) +
  labs(y = "RT (sec)", x = NULL) +
  coord_flip() +
  facet_wrap(~age_category, ncol = 1)

# get model values
ms_rt_e1 <- d_bda_noise$rt_noise %>% 
  group_by(noise_condition, age_category) %>% 
  summarise(m_rt = mean(rt_ms_scale),
            hdi_lower = quantile(rt_ms_scale, probs = 0.025),
            hdi_upper = quantile(rt_ms_scale, probs = 0.975)) %>% 
  mutate_if(.predicate = is.numeric, .funs = round, digits = 2) %>% 
  mutate(age_category = factor(age_category) %>% fct_rev()) 

p_rt <- p_rt +
  geom_pointrange(aes(ymax = hdi_upper, ymin = hdi_lower), 
                  data = ms_rt_e1,
                  color = "red",
                  shape = 15,
                  size = 0.7)

# make pairwise differences plot
diffs_df <- ss %>% 
  select(m_rt, subid, noise_condition, age_category) %>% 
  spread(noise_condition, m_rt) %>% 
  group_by(age_category) %>% 
  mutate(diff = noise - clear) 

ms_diffs <- diffs_df %>% 
  group_by(age_category) %>% 
  langcog::multi_boot_standard(column = "diff", na.rm = T, nboot = nboot, 
                               empirical_function = "mean") %>% 
  rename(diff = mean)

pairwise_diffs_plot <- diffs_df %>% 
  mutate(title = "Pairwise contrast") %>%  # hack to get plots to line up nicely
  ggplot(aes(x = fct_rev(age_category), y = diff)) +
  geom_jitter(shape = pt_shape, 
              width = 0.1, 
              color = pt_color, 
              size = pt_size,
              fill = pt_fill,
              alpha = pt_alpha) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_pointrange(aes(ymin = summary_ci_lower, ymax = summary_ci_upper), 
                  data = ms_diffs,
                  shape = 15,
                  size = 0.7,
                  color = "red") +
  ylim(-0.45, 0.7) +
  labs(x = NULL, y = "RT difference (sec)") +
  facet_wrap(~title) +
  coord_flip() 

p_rt <- plot_grid(p_rt, pairwise_diffs_plot, ncol = 2, rel_widths = c(0.8, 1),
                  scale = c(1, 0.8))
```

### Merge behavioral plots and save

```{r}
noise_fst_shifts <- plot_grid(p_rt, p_acc, ncol = 1, rel_heights = c(1,1), 
                              labels = c("B", "C"))
noise_behav_plot <- plot_grid(noise_timecourse_plot, noise_fst_shifts, rel_widths = c(1, 1),
                              labels = c("A"))

save_plot(filename = here::here("paper/journal_submission/figures/figs_output/fig5_noise_behav.png"), 
          noise_behav_plot,
          ncol = 3,
          nrow = 1.7,
          base_aspect_ratio = 1)
```

## Model-based plots

### Control chart

```{r}

```


### EWMA guessing

### HDDM parameter estimates

### Merge and save model plots