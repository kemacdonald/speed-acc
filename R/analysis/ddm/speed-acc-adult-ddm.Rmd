---
title: "Speed-acc-adult Drift Diffusion Analysis (DDM)"
author: "Kyle MacDonald"
output: html_document
---

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=F, cache=F, message=F, sanitize = T)
source("../../helper_functions/libraries_and_functions.R")
```

Read data.

```{r read data}
d <- read_csv("../../../data/3_final_merged_data/speed_acc_adult_ewma_results.csv")

theme_set(ggthemes::theme_few())
```

## Plot RT histograms of guesses and valid responses

Note that these categories were generated the EWMA guessing model.

```{r rt_dist_histogram, fig.height=8}
ggplot(aes(x = rt, color = shift_accuracy), data = d) +
  #geom_histogram(alpha = 0.7, position = "identity", ) +
  geom_freqpoly(size = 1) +
  ylab("Density") +
  xlab("RT (sec)") +
  facet_grid(condition~guess) +
  scale_color_manual(values = c("darkorange", "dodgerblue")) +
  ggthemes::theme_few() +
  theme(legend.position = "top",
        panel.spacing = unit(2, "lines"))
```


## Drift Diffusion Analysis

Workflow taken from Nordmeyer et al. (2016). The goal is to estimate parameters separately for each participant and then we aggregate across participants to get means & confidence intervals on the parameter estimates.

The parameters of the drift drift diffusion model are: 

* $\alpha$ = boundary separation: speed-accuracy tradeoff (higher values mean higher prioritization of accuracy over speed)
* $\beta$ = initial bias
* $\delta$ = drift rate: speed of information processing (close to zero means ambiguous information)
* $\tau$ = nondecision time: motor response time

```{r setup_df}
# get the data we care about and format for Rwiener functions
# columns need to be named "q" for RT and "resp" for response
# you can also set your RT cutpoints here using the filter function and
# remove trials flagged as guesses by the EWMA
d.ddm <- d %>% 
  filter(RT > 0.1, RT <= 1) %>% 
  select(subid, condition, RT, correct) %>% 
  mutate(resp = ifelse(correct == "0", "lower", "upper")) %>% 
  rename(q = RT) 
```

Fit DDM for each participant and each condition. Note that we are using the do() function to apply the ddm fit function for each participant and condition. The fit_ddm function is in the libraries_and_functions.R file. Also note that this will take a couple of minutes to fit.

```{r estimate_ddm_params}
sub.pars.df <- d.ddm %>% 
  group_by(subid, condition) %>% 
  do(fit_ddm(., condition_col = "condition", subid_col = "subid", 
             bysub = T, niter = 500)) 
```

Filter parameter estimates to remove extereme values. Here, we are calling it +/- 2sd from the mean for each condition and parameter. Note that this is an exploratory analysis decision since I decided to filter after looking at the data. 

```{r munge_params}
sub.pars.df.filt <- sub.pars.df %>% 
  group_by(condition, param) %>% 
  filter(convergence == 0) %>% # a value of 0 means the model converged
  do(remove_extreme_vals(., sd_cut_val = 2, value_column = "fit.vals"))
```

Boxplot for parameter values by condition:

```{r boxplot_params, fig.width=9}
ggplot(aes(x = condition, y = fit.vals, fill = condition), 
       data = filter(sub.pars.df.filt, param != "bias")) +
  geom_boxplot(alpha = 0.7) +
  guides(fill = F) +
  geom_jitter(alpha = 0.5, position = position_jitterdodge(jitter.width = 0.1)) + 
  labs(x= "Condition", y = "Mean Param Value") +
  facet_wrap(~param, scales = "free", ncol = 4)
```

## Stats for DDM parameters

Repeated measures ANOVA. Linear mixed effects model doesn't add much value here since we are doing inference over the parameter estimates for each participant (i.e., we only have 3 data points from each person).

This analysis is exploratory since we didn't have predictions about what these parameter estimates would look like after filtering out the fast guesses that we flagged using the EWMA model. 
