---
title: "Speed-acc-adult Fit EWMA model"
author: "Kyle MacDonald"
output: html_document
---

This script analyzes first shift accuracy and RT using an EWMA guesssing model. In the task, we vary the information value and the saliency of the center fixation and measure the effects on accuracy and RT.

## Setup

Load libraries and read in tidy data.

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo=F, warning=F, cache=F, message=F, sanitize = T)
source("../../helper_functions/libraries_and_functions.R")
library(tidyverse)
```

```{r read data}
read.path <- "../../../data/3_final_merged_data/"
d.fs <- read_csv(paste0(read.path, "speed_acc_adult_text_fstshift_tidy.csv.gz"))
d.asl <- read_csv(paste0(read.path, "speed-acc-participant-level-df.csv"))
```

Clean the spoken English and sign language datasets, so we can merge them.

```{r clean datasets to merge}
d.asl %<>% 
  filter(language_modality == "ASL" & age_code == "adult") %>% 
  mutate(subid = as.character(Sub.Num),
         tr.num = Tr.Num, 
         rt = RT_sec,
         shift_type = trial_type,
         condition = language_modality, 
         hearing_status = hearing_status_participant,
         response_onset_type = "noun") %>% 
  select(subid, tr.num, rt, shift_type, hearing_status, condition, response_onset_type)

d.fs %<>%
  mutate(hearing_status = "hearing") %>% 
  select(subid, tr.num, rt, shift_type, hearing_status, condition, response_onset_type)
```

Merge the datasets.

```{r merge asl and english data}
d.fs %<>% bind_rows(., d.asl) %>% 
  mutate(shift_accuracy = ifelse(shift_type == "C_T", "correct", "incorrect"))
```

### RT analysis

First, we analyze RT and accuracy of first shifts computed from noun onset.

```{r}
d.fs %>% 
  filter(shift_type %in% c("C_T", "C_D")) %>% 
  group_by(shift_type, response_onset_type) %>% 
  count() %>% 
  group_by(response_onset_type) %>% 
  mutate(total_shifts = sum(n), 
         prop = round(n / total_shifts, 2)) %>% 
  kable()
```

Regardless of when you start the clock, ~10% of shifts are incorrect. This makes sense since this is an easy task for adults. 

```{r summarize RT for correct and incorrect shifts}
ss.d.rt <- d.fs %>% 
  filter(shift_type %in% c("C_T", "C_D"), 
         response_onset_type %in% c("noun", "sentence")) %>% 
  dplyr::select(subid, tr.num, condition, shift_accuracy, rt, response_onset_type) %>% 
  unique()

ms.rt <- ss.d.rt %>% 
  group_by(condition, shift_accuracy, response_onset_type) %>% 
  summarise(med = median(rt))
```

Plot the distribution of RTs for correct vs. incorrect shifts from noun onset.

```{r, fig.width = 8, fig.height = 8}
ss.d.rt %>% 
  mutate(resp_type_fac = factor(response_onset_type, levels = c("sentence", "noun"))) %>% 
  filter(response_onset_type == "noun") %>% 
  ggplot(aes(x = rt, fill = shift_accuracy), data = .) +
  #geom_density(alpha = 0.7, adjust = 1.5) + 
  geom_histogram(position = "identity", color = "black") +
  facet_grid(condition~resp_type_fac) +
  guides(color = F) + 
  ylab("Density") +
  xlab("RT (sec)") +
  scale_fill_manual(values = c( "darkorange", "dodgerblue")) +
  labs(fill = "Shift accuracy")
```

I'm not sure how we should handle shifts that happen before noun onset? My thought is to feed them into the EWMA, but not into the summary analyses and the DDM fits.

#### Plot RT by condition

First we aggregate median RT for each participant.

```{r}
ss.rt <- ss.d.rt %>% 
  filter(response_onset_type == "noun") %>% 
  group_by(condition, subid, shift_accuracy) %>% 
  summarise(m_rt = mean(rt))
```

Then we make a boxplot.

```{r}
ggplot(aes(x = condition, y = m_rt, fill = shift_accuracy), data = ss.rt) +
  geom_boxplot(width = 0.4) +
  scale_fill_manual(values = c("darkorange", "dodgerblue")) +
  labs(x = "Condition", 
       y = "Mean RT (sec)") +
  theme(text = element_text(size = 16),
        legend.position = "top") 
```

Get an estimate of the effect size for the RT difference between ASL and Face conditions.

```{r}
effsize::cohen.d(filter(ss.rt, condition == "ASL")$m_rt,
        filter(ss.rt, condition == "face")$m_rt)
```

### Accuracy

First we aggregate mean Accuracy for each participant.

```{r}
ss.acc <- ss.d.rt %>% 
  filter(response_onset_type == "noun") %>% 
  mutate(correct_num = ifelse(shift_accuracy == "correct", 1, 0)) %>% 
  group_by(condition, subid) %>% 
  summarise(mean_acc = mean(correct_num))
```

Then we make a boxplot.

```{r}
ggplot(aes(x = condition, y = mean_acc), data = ss.acc) +
  geom_boxplot(width = 0.3, fill = "grey", alpha = 0.7) +
  labs(x = "Condition", 
       y = "Mean Accuracy") +
  theme(text = element_text(size = 12))
```

## EWMA filter to model guessing behavior 

First we munge the data to feed into the EWMA function.

```{r ewma munge}
d.fs.ewma <- d.fs %>% 
  dplyr::select(subid, tr.num, shift_accuracy, rt, response_onset_type, condition) %>% 
  filter(is.na(rt) == F, response_onset_type == "noun") %>% 
  mutate(correct = ifelse(shift_accuracy == "correct", 1, 0), 
         RT = rt)
```

Fit the EWMA model and plot results. 

TODO: Simulate this model across different values of *L* and $\lambda$. *L* controls the width of the threshold. $\lambda$ controls the number of previous trials that go into the moving average computation.

```{r ewma model}
ss.ewma.results <- d.fs.ewma %>% 
  group_by(condition) %>% 
  do(ewma_function(., rt_column = "RT", L = 3, lambda = .01)) %>% 
  mutate(rt = round(as.numeric(rt), 2),
         cs = round(as.numeric(cs), 2),
         ucl = round(as.numeric(ucl), 2),
         guess = ifelse(cs < ucl, "guess", "response"),
         guess_num = ifelse(guess == "response", 1, 0),
         ucl_bound = abs(ucl-cs)) %>% 
  gather(key = ewma_param, value = param_value, cs:ucl) 
```

Write EWMA results to .csv so we can use this information in the Drift Diffusion analysis. 

```{r write emwa, eval = F}
write_csv(ss.ewma.results, "../../../data/3_final_merged_data/speed_acc_adult_ewma_results.csv")
```
