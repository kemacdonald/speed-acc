---
title: "Speed-acc-adult EWMA analysis"
author: "Kyle MacDonald"
date: "10/20/2016"
output: html_document
---

This script analyzes first shift accuracy and RT using an EWMA guesssing model. In the task, we vary the information value and the saliency of the center fixation and measure the effects on accuracy and RT.

## Setup

Load libraries and read in tidy data.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=F, cache=F, message=F, sanitize = T)
source("../../helper_functions/libraries_and_functions.R")
```

```{r read data}
read.path <- "../../../data/3_final_merged_data/"
d.fs <- read_csv(paste0(read.path, "speed_acc_adult_fstshift_tidy.csv"))
d.asl <- read_csv(paste0(read.path, "speed-acc-ss-df.csv"))
```

```{r clean datasets to merge}
d.asl %<>% 
  filter(language_modality == "ASL" & age_code == "adult") %>% 
  mutate(subid = as.character(Sub.Num),
         tr.num = Tr.Num, 
         rt = RT_sec,
         shift_type = trial_type,
         condition = language_modality, 
         hearing_status = hearing_status_participant,
         response_onset_type = "noun") %>% 
  select(subid, tr.num, rt, shift_type, hearing_status, condition, response_onset_type)

d.fs %<>%
  mutate(hearing_status = "hearing") %>% 
  select(subid, tr.num, rt, shift_type, hearing_status, condition, response_onset_type)
```

```{r merge asl and english data}
d.fs %<>% bind_rows(., d.asl) %>% 
  mutate(shift_accuracy = ifelse(shift_type == "C_T", "correct", "incorrect"))
```

### RT analysis

First, we analyze RT and accuracy of first shifts that are computed from noun onset.

```{r}
d.fs %>% 
  filter(shift_type %in% c("C_T", "C_D")) %>% 
  group_by(shift_type, response_onset_type) %>% 
  count() %>% 
  group_by(response_onset_type) %>% 
  mutate(total_shifts = sum(n), 
         prop = round(n / total_shifts, 2)) %>% 
  kable()
```

Regardless of when you start the clock, only ~10% of shifts are incorrect, This makes sense since this is an easy task for adults. 

```{r summarize RT for correct and incorrect shifts}
ss.d.rt <- d.fs %>% 
  filter(shift_type %in% c("C_T", "C_D"), 
         response_onset_type %in% c("noun", "sentence")) %>% 
  dplyr::select(subid, tr.num, condition, shift_accuracy, rt, response_onset_type) %>% 
  unique()

ms.rt <- ss.d.rt %>% 
  group_by(condition, shift_accuracy, response_onset_type) %>% 
  summarise(med = median(rt))
```

Distribution of RTs for correct vs. incorrect shifts from noun onset and from sentence onset

```{r, fig.width = 8, fig.height = 8}
ggplot(aes(x = rt, fill = shift_accuracy), data = ss.d.rt) +
  #geom_density(alpha = 0.7, adjust = 1.5) + 
  geom_histogram(alpha = 0.7, position = "identity") +
  facet_grid(condition~response_onset_type) +
  geom_vline(aes(xintercept = med, color = shift_accuracy), size = 1, lty = "dashed", 
             data = ms.rt) +
  guides(color = F) + 
  ylab("Density") +
  xlab("RT (sec)") +
  scale_fill_manual(values = c("darkorange", "dodgerblue")) +
  scale_color_manual(values = c("darkorange", "dodgerblue")) +
  theme(text = element_text(size=18),
        legend.position = "top",
        panel.spacing = unit(2, "lines"))
```

What should we do with shifts that happen before noun onset? My thought is to feed them into the EWMA, but not into the summary analyses and the DDM fits.

#### Plot RT by condition

First we aggregate median RT for each participant.

```{r}
ss.rt <- ss.d.rt %>% 
  filter(response_onset_type == "noun") %>% 
  group_by(condition, subid, shift_accuracy) %>% 
  summarise(m_rt = mean(rt))
```

Then we make a boxplot.

```{r}
ggplot(aes(x = condition, y = m_rt, fill = shift_accuracy), data = ss.rt) +
  geom_boxplot(width = 0.4) +
  scale_fill_manual(values = c("darkorange", "dodgerblue")) +
  labs(x = "Condition", 
       y = "Mean RT (sec)") +
  theme(text = element_text(size = 16),
        legend.position = "top") 
```

### Accuracy

First we aggregate mean Accuracy for each participant.

```{r}
ss.acc <- ss.d.rt %>% 
  filter(response_onset_type == "noun") %>% 
  mutate(correct_num = ifelse(shift_accuracy == "correct", 1, 0)) %>% 
  group_by(condition, subid) %>% 
  summarise(mean_acc = mean(correct_num))
```

Then we make a boxplot.

```{r}
ggplot(aes(x = condition, y = mean_acc), data = ss.acc) +
  geom_boxplot(width = 0.3, fill = "dodgerblue", alpha = 0.7) +
  labs(x = "Condition", 
       y = "Mean Accuracy") +
  theme(text = element_text(size = 16))
```

```{r}
ggplot(aes(x = condition, y = mean_acc), data = ss.acc) +
  geom_violin(fill = "dodgerblue", alpha = 0.5) +
  labs(x = "Condition", 
       y = "Mean Accuracy") +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  theme(text = element_text(size = 16))
```

```{r}
acc.glmer <- ss.d.rt %>% 
  filter(response_onset_type == "noun") %>% 
  mutate(correct_num = ifelse(shift_accuracy == "correct", 1, 0)) %>% 
  glmer(correct_num ~ condition + (1|subid), data = ., 
        family = "binomial", 
        nAGQ = 0)
  
```

## EWMA filter to model guessing behavior 

First we munge the data to feed into the EWMA function.

```{r ewma munge}
d.fs.ewma <- d.fs %>% 
  dplyr::select(subid, tr.num, shift_accuracy, rt, response_onset_type, condition) %>% 
  filter(is.na(rt) == F, response_onset_type == "noun") %>% 
  mutate(correct = ifelse(shift_accuracy == "correct", 1, 0), 
         RT = rt)
```

Fit the EWMA model and plot results. 

TODO: Simulate this model across different values of *L* and $\lambda$. *L* controls the width of the threshold. $\lambda$ controls the number of previous trials that go into the moving average computation.

```{r ewma model}
ss.ewma.results <- d.fs.ewma %>% 
  group_by(condition) %>% 
  do(ewma_function(., rt_column = "RT", L = 3, lambda = .01)) %>% 
  mutate(rt = round(as.numeric(rt), 2),
         cs = round(as.numeric(cs), 2),
         ucl = round(as.numeric(ucl), 2),
         guess = ifelse(cs < ucl, "guess", "response"),
         guess_num = ifelse(guess == "response", 1, 0),
         ucl_bound = abs(ucl-cs)) %>% 
  gather(key = ewma_param, value = param_value, cs:ucl) 

# Aggregate cutoffs for each participant
# TODO: how to handle participants who do not cross the guessing threshold? (i.e., censored data)
ss.cutoffs <- ss.ewma.results %>% 
  filter(guess == "response") %>% 
  group_by(condition, subid) %>% 
  summarise_(cutoff = interp(~ min(x), x = as.name("rt")))

# Aggregate cutoffs for each condition.
ms.cutoffs <- ss.cutoffs %>% 
  group_by(condition) %>% 
  summarise(cutoff = median(cutoff))
```

Write EWMA results to .csv so we can use this information in the Drift Diffusion analysis. 

```{r write emwa}
write_csv(ss.ewma.results, "../../../data/3_final_merged_data/speed_acc_adult_ewma_results.csv")
```

Now make a pretty EWMA plot ("control chart"). 

```{r ewma plot, fig.height=8}
ggplot(data = ss.ewma.results, aes(x = rt, y = param_value, color = ewma_param)) +
  geom_line(size = 1) +
  geom_vline(aes(xintercept = cutoff), linetype = 2, data = ms.cutoffs) +
  geom_hline(yintercept = 0.5, linetype = "solid") +
  labs(x = "RT (sec)", y = "EWMA statistic") +
  guides(color=F) + 
  xlim(0, 1) +
  facet_grid(condition~.) +
  scale_color_manual(values = c("darkorange", "dodgerblue")) +
  geom_dl(aes(label = ewma_param), method = "last.bumpup") +
  theme(text = element_text(size = 15))
```

What do we see? The bullseye condition crosses the threshold after 1 second. The face, text, and text-audio all cross the threshold earlier in the window. Text-no-audio crosses earliest given these parameters of the EWMA model. Finally, in the text-no-audio condition there aren't any early RTs to model. How should we add this information to the analysis?

What we can do is compute the proportion of shifts that were categorized as a "fast guess" compared to a "valid response" for each participant for each condition.

```{r}
ss.guessing.prop <- ss.ewma.results %>% 
  group_by(subid, condition, guess) %>% 
  summarise(count = n()) %>% 
  mutate(prop.guessing = round(count / sum(count), 2))
```

Boxplot of proportion guessing by condition.

```{r}
ggplot(aes(x = fct_rev(condition), y = prop.guessing), 
       data = filter(ss.guessing.prop, guess == "guess")) +
  geom_boxplot(fill = "dodgerblue", width = 0.3, alpha = 0.7) +
  labs(x = "Condition",y = "Prop. Guess") +
  theme(text = element_text(size = 15))
```

This looks like what we saw in the EWMA control charts: bullseye is mostly guesses, whereas face, text, and text-no-audio are mostly valid responses. However, this analysis still does not caputre one effect in the EWMA chart, which is the amount of *time* each participant spends in a guessing phase vs. a valid response phase for each condition.

To get at this effect, we use a function to compute the difference in time from first guessing response to first valid response for each participant for each condition. 

```{r}
ss.guessing.window <- ss.ewma.results %>% 
  group_by(subid, condition) %>% 
  do(compute_guessing_window(.)) %>% 
  dplyr::select(subid, time_guessing, condition) %>%
  mutate(time_guessing = as.numeric(time_guessing)) %>% 
  unique()
```

Boxplot of time guessing across the different conditions.

```{r}
ggplot(aes(x = fct_rev(condition), y = time_guessing), data = ss.guessing.window) +
  geom_boxplot(fill = "dodgerblue", width = 0.3, alpha = 0.7) +
  labs(x = "Condition", y = "Avg. Time Guessing (sec)") +
  coord_flip() +
  theme(text = element_text(size = 15))
```

## Stats for EWMA parameters

Model the effect of condition on the the trial-level guessing vs. non-guessing responses. Note that the outcome measure -- guessing behavior -- is determined by the EWMA control process model described above. 

In this model, we include a fixed effect of condition and a random effect of participant. We also test the following contrasts of interest: 

* Bullseye vs. Face/Text/Text-no-audio
* Text vs. No-text
* Text-audio vs. Text-no-audio
* Bullseye vs. Face

```{r glmer guessing behavior}
# contrast coding to test comparisons of interest
# todo: fix contrast coding so model is not rank deficient
ss.ewma.results$condition_fact <- as.factor(ss.ewma.results$condition)

contrasts(ss.ewma.results$condition_fact) <- cbind("noaudio_vs_audio" = c(1, 1, 1, -3), 
                                      "textaudio_vs_textnoaudio" = c(0, 0, 1, -1))

m1 <- glmer(guess_num ~ condition_fact + (1 + condition |subid), 
            data = ss.ewma.results,
            nAGQ = 0,
            family = binomial)

summary(m1)$coef %>% kable()
```

#### ANOVA for time spent guessing

```{r anova guessing window}
summary(aov(time_guessing ~ condition, data = ss.guessing.window))
```

#### ANOVA for cutoffs

```{r}
summary(aov(cutoff ~ condition, data = ss.cutoffs))
```

