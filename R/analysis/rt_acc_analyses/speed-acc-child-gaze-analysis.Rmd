---
title: "Speed-Acc Child Gaze Analysis"
author: "Tami Alade and Kyle MacDonald"
output: html_document
---

## Set up 

Here are some helpful links for understanding the workflow for analyzing data in R Markdown (what you're doing in this document!):

 * [Scripts](http://r4ds.had.co.nz/workflow-scripts.html)
 * An R Markdown [guide](https://docs.google.com/document/d/1ajv1VJqEheVws93tnzH-K7145vBKtwD3Az5pg3faRdw/edit?usp=sharing) that I wrote for the lab
 
```{r chunk_options, echo = F}
# code to clear workspace
rm(list=ls()) 

# set some global options
knitr::opts_chunk$set(warning=F, message=F, sanitize = T, 
                      fig.height=5, fig.width=8, echo=T, cache = F)
```

```{r}
# read in personal library of helper functions
source("../../helper_functions/libraries_and_functions.R")
```

## Load data

Section 11.2 from [this](http://r4ds.had.co.nz/data-import.html) chapter on data importing is great.

```{r}
d <- read_csv("../../../data/3_final_merged_data/first_shifts/speed_acc_child_gaze_fstshift_tidy.csv")
```

## Check the data

The goal of this section is to make sure the data match our expectations, or in other words, we are "testing" our data. Usually this involves comparing a known value to the number actually in the data set. For example, I know how I ran 20 participants, do I have 20 unique participant IDs?

[This](http://r4ds.had.co.nz/transform.html) chapter from the book **R for Data Science** is a good reference for writing code to manipulate data to do data "sanity" checks.

How many participants in the dataset?  

```{r}
by_id <- group_by(d, subid)
summary_by_id <- summarise(.data = by_id)
count(summary_by_id)
```

How many trials do we have for each participant?

```{r}
by_trial <- group_by(d, subid, tr.num)
summary_by_trial <- summarise(.data = by_trial)
count(summary_by_trial)
```

How many trials in each condition? 

```{r}
d %>% 
  group_by(subid, gaze_condition) %>% 
  summarise(n_trials = n()) %>% 
  kable()
```

## Compute age 

```{r}
d %<>% 
  mutate(age = as.double(run_date - birthday),
         age_years = age / 365,
         age_group = as.integer(age / 365))
```


## Explore data via visualization

[This](http://r4ds.had.co.nz/data-visualisation.html) is a great book chapter on data visualization using the ggplot2 R package

### Visualize data distributions

My goal when I visualize the distribution of a variable is usually to check if there any data points that look like outliers (really different from the other values in the sample). There are more precise, quantitative ways to define outlier, but the visualization helps us spot them quickly. If some observations look really different, I then try to reason about why that might be the case: data entry error? equipment measurement error? 

What does the distribution of age in the sample look like? 

```{r}
d %>% 
  ggplot(aes(x = age_years)) +
  geom_histogram()
```

```{r}
d %>% 
  select(subid_short, age_group) %>% 
  unique() %>% 
  ggplot(aes(x = age_group)) +
  geom_histogram()
```

What about Reaction Times (RT)?

```{r}
ggplot(aes(x = rt), data = d) +
  geom_histogram()
```

What about Accuracy? 

```{r}
d %>% 
  filter(shift_type %in% c("C_T", "C_D")) %>% 
  ggplot(aes(x = shift_accuracy)) +
  geom_bar()
```

## Filter the data

Next, let's remove extreme RTs. 

```{r}
d.filt <- d %>% filter(rt <= 5)
```

Remove participants who couldn't calibrate and who had alots of missing looks

```{r}
d.filt %<>% filter(keep_et == "include",
                   exclude == "keep")
```

### Visualize Accuracy

What is the overall accuracy of first shifts?

```{r}
ss <- d.filt %>% 
  filter(!is.na(shift_accuracy),
         shift_type %in% c("C_T", "C_D")) %>% 
  group_by(gaze_condition, subid, shift_accuracy, age_group) %>% 
  summarise(n = n()) %>% 
  group_by(subid, gaze_condition, age_group) %>% 
  mutate(total_trials = sum(n),
         prop = round(n / total_trials, 2)) 
```

```{r}
# aggregate at the condition level
ms <- ss %>% 
  filter(shift_accuracy == "correct") %>% 
  group_by(gaze_condition) %>% 
  multi_boot_standard(column = "prop") 
  
ms %<>% rename(prop = mean)
```

Now make a boxplot of the accuracy data for each condition. Note that we have to first filter out the proprotion "incorrect" rows, so we are only seeing the proprotion correct data.

```{r}
acc_boxplot <- ss %>% 
  filter(shift_accuracy == "correct") %>% 
  ggplot(aes(x = gaze_condition, y = prop)) +
  geom_boxplot(width = 0.5, fill = "dodgerblue") +
  geom_jitter(width = 0.05, alpha = 0.3) + 
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  labs(x = "Condition", y = "Prop. Correct") +
  theme(text = element_text(size = 18))
```

Plot the mean accuracy and confidence interval for each condition.

```{r}
ms %>% 
  ggplot(aes(x = gaze_condition, y = prop)) +
  geom_pointrange(aes(ymin = summary_ci_lower, ymax = summary_ci_upper)) +
  ylim(0.4, 0.8) +
  geom_hline(yintercept = 0.5, linetype = "dashed")
```

### Visualize Reaction Time

What is the overall RT for kids in the experiment? 

```{r}
rt_boxplot <- d.filt %>% 
  filter(!is.na(shift_accuracy), 
         shift_type %in% c("C_T", "C_D"),
         rt <= 1.5) %>% 
  group_by(subid, gaze_condition) %>% 
  summarise(m_rt = mean(rt)) %>% 
  ggplot(aes(x = gaze_condition, y = m_rt)) + 
  geom_boxplot(width = 0.5, fill = "#de2d26") +
  geom_jitter(width = 0.05, alpha = 0.3) + 
  ylim(0,1) +
  labs(x = "Condition", y = "RT (sec)") +
  theme(text = element_text(size = 18))
```

```{r}
cowplot::plot_grid(rt_boxplot, acc_boxplot)
```

What about RTs for correct vs. incorrect shifts?

```{r}
d %>% 
  filter(!is.na(shift_accuracy), 
         shift_type %in% c("C_T", "C_D"),
         rt <= 1.5) %>% 
  group_by(subid, gaze_condition, shift_accuracy) %>% 
  summarise(m_rt = mean(rt)) %>% 
  ggplot(aes(x = gaze_condition, y = m_rt, fill = shift_accuracy)) + 
  geom_boxplot(width = 0.5) +
  ylim(0,1) +
  labs(x = "Condition", y = "RT (sec)") +
  theme(text = element_text(size = 18))
```

```{r}
acc_colors <- c("grey10", "black")
fill_vals <- c("grey90", "darkviolet")

p <- d.filt %>% 
  filter(is.na(rt) == F) %>% 
  ggplot(aes(x = forcats::fct_rev(gaze_condition), y = rt)) +
  ggbeeswarm::geom_quasirandom(shape = 21, fill = "grey10", color = "black") + 
  #scale_color_manual(values = acc_colors) +
  #scale_fill_manual(values = fill_vals) +
  labs(y = "RT (sec)", x = NULL) +
  theme_bw() +
  theme(legend.position = "right") + 
  theme(axis.title.x = element_text(size = 16, 
                                    face = "bold"), 
        axis.title.y = element_text(size = 16,
                                    face = "bold"), axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 16)) +
  coord_flip()

p
```

### Block effects RT

```{r}
d.filt %<>% mutate(block = ifelse(tr.num <= 16, "block_1", "block_2"))
```

Now, let's plot RT as a function of block

```{r}
ss <- d.filt %>% 
  filter(shift_type %in% c("C_T", "C_D")) %>% 
  group_by(subid, gaze_condition, shift_accuracy, block) %>% 
  summarise(m_rt = mean(rt))
```

```{r}
ss %>% 
  ggplot(aes(x = gaze_condition, y = m_rt, fill = shift_accuracy)) + 
  geom_boxplot() +
  facet_wrap(~block) +
  theme_bw()
```

### Block effects Accuracy

```{r}
ss.acc <- d.filt %>% 
  filter(shift_type %in% c("C_T", "C_D")) %>% 
  group_by(subid, gaze_condition, block, shift_accuracy) %>% 
  summarise(n_trials = n()) %>% 
  group_by(subid, gaze_condition, block) %>% 
  mutate(n_total_trials = sum(n_trials),
         prop = n_trials / n_total_trials)
```

```{r}
ss.acc %>% 
  filter(shift_accuracy == "correct") %>% 
  ggplot(aes(x = gaze_condition, y = prop)) + 
  geom_boxplot(width = 0.3) +
  geom_jitter(alpha = 0.4, width = 0.05) +
  ylim(0,1) +
  geom_hline(yintercept = 0.5, linetype == "dashed") +
  facet_wrap(~block) +
  theme_bw() 
```

### Accuracy as a function of RT

```{r}
d.cut <- d.filt %>% 
  filter(rt <= 2) %>% 
  mutate(rt_bin = cut(rt, breaks = 4)) 
```


```{r}
ss.acc.rt <- d.cut %>% 
  filter(shift_type %in% c("C_T", "C_D")) %>% 
  group_by(subid, gaze_condition, shift_accuracy, rt_bin) %>% 
  summarise(n_trials = n()) %>% 
  group_by(subid, gaze_condition, rt_bin) %>% 
  mutate(n_total_trials = sum(n_trials),
         prop = n_trials / n_total_trials)
```


```{r}
ms <- ss.acc.rt %>% 
  filter(shift_accuracy == "correct") %>% 
  group_by(gaze_condition, shift_accuracy, rt_bin) %>% 
  multi_boot_standard(column = "prop", nboot = 100)  
```
  
```{r}
ms %>% 
  ggplot(aes(x = rt_bin, y = mean, color = gaze_condition)) + 
  geom_pointrange(aes(ymin = summary_ci_lower, ymax = summary_ci_upper), position = position_jitter(width = .2)) + 
  #geom_jitter(alpha = 1, width = 0.05) +
  ylim(0,1.1) +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  theme_bw() 
```


## Statistical models

We can talk more about this aspect of the anlaysis once you made some progress on data viz. 


