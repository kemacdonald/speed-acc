---
title: "Speed-Acc Child Noise Analysis"
author: "Hannah Slater and Kyle MacDonald"
output: html_document
---

## Set up 

Here are some helpful links for understanding the workflow for analyzing data in R Markdown (what you're doing in this document!):

 * [Scripts](http://r4ds.had.co.nz/workflow-scripts.html)
 * An R Markdown [guide](https://docs.google.com/document/d/1ajv1VJqEheVws93tnzH-K7145vBKtwD3Az5pg3faRdw/edit?usp=sharing) that I wrote for the lab
 
```{r chunk_options, echo = F}
# code to clear workspace
rm(list=ls()) 

# set some global options
knitr::opts_chunk$set(warning=F, message=F, sanitize = T, 
                      fig.height=5, fig.width=8, echo=T, cache = F)

# read in personal library of helper functions
source("../../helper_functions/libraries_and_functions.R")
```

## Load data

Section 11.2 from [this](http://r4ds.had.co.nz/data-import.html) chapter on data importing is great.

```{r}
table1 <- read_csv("../../../data/3_final_merged_data/first_shifts/speed_acc_child_noise_fstshift_tidy.csv")
```

## Check the data

The goal of this section is to make sure the data match our expectations, or in other words, we are "testing" our data. Usually this involves comparing a known value to the number actually in the data set. For example, I know how I ran 20 participants, do I have 20 unique participant IDs?

[This](http://r4ds.had.co.nz/transform.html) chapter from the book **R for Data Science** is a good reference for writing code to manipulate data to do data "sanity" checks.

How many participants in the dataset?  

```{r}
unique <- apply(table1, 2, function(x)length(unique(x)))
participants <- unique[1]
print(participants)
```

How many trials do we have for each participant?

```{r}
trials_number <- unique[2]
print(trials_number)
# not every participant has the same number of trials
```

```{r}
table1 %>% 
  group_by(subid, noise_condition) %>% 
  summarise(n_trials = n())
```


How many trials in each condition? 

```{r}
trials <- table(table1["noise_condition"])
num_no_noise <- trials["no_noise"]
num_noise <- trials["noise"]
```

## Clean up the data

Add variable that stores information about center-initial shifts

```{r}
table1 <- table1 %>% 
  mutate(shift_start_location = ifelse(shift_type %in% c("C_T", "C_D"), 
                                       "center", 
                                       "not_center"))
```

Remove shifts that do not start at center, participant exclusions

```{r}
table1.analysis <- table1 %>% 
  filter(shift_start_location == "center",
         !(is.na(shift_accuracy)),
         keep == "include",
         exclude == "keep")
```

## Explore data via visualization

[This](http://r4ds.had.co.nz/data-visualisation.html) is a great book chapter on data visualization using the ggplot2 R package

### Visualize data distributions

My goal when I visualize the distribution of a variable is usually to check if there any data points that look like outliers (really different from the other values in the sample). There are more precise, quantitative ways to define outlier, but the visualization helps us spot them quickly. If some observations look really different, I then try to reason about why that might be the case: data entry error? equipment measurement error? 

What does the distribution of age in the sample look like? 

```{r}
ggplot(data = table1.analysis) + geom_point(mapping = aes(x= subid, y=age)) +
  scale_colour_manual(values = c("darksalmon", "firebrick")) +
 # geom_point(aes(colour = noise_condition)) +
  theme(plot.background = element_rect(fill = "blanchedalmond", colour = "blanchedalmond"))
```

What about Reaction Times (RT)?

```{r}
table1.analysis %>% 
  ggplot() + geom_point(mapping = aes(x = subid_short, y = rt))
```

What about Accuracy? 

```{r}
table1.analysis %>% 
  ggplot() + 
  geom_bar(mapping = aes(x = as.factor(subid_short), fill = shift_accuracy)) +
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~noise_condition)
```

### Visualize Accuracy

When thinking about 

What is the overall accuracy of first shifts?

```{r}
table1.analysis %>% 
  ggplot() + geom_bar(mapping = aes(x = shift_accuracy))
```

What about the accuracy for each condition?

```{r}
table1.analysis %>% 
  ggplot() + 
  geom_bar(mapping = aes(x = noise_condition, fill = shift_accuracy), position = "fill") 
```

### Visualize Reaction Time

What is the overall RT for kids in the experiment? 

```{r}
table1.analysis %>% 
  ggplot() + 
  geom_density(mapping = aes(x = rt, fill = noise_condition), 
               alpha = 0.4)
```

## Aggregated visualizations

```{r}
ss.rt <- table1.analysis %>% 
  group_by(subid_short, noise_condition) %>% 
  summarise(m_rt = median(rt))
```

```{r}
ss.rt %>% 
  ggplot(aes(x = noise_condition, y = m_rt)) + 
  geom_boxplot(width = 0.3) +
  geom_jitter(width = 0.03, alpha = 0.6) +
  ylim(0,1.5)
```

Let's try visualizing RT distributions using dotplots

```{r}
acc_colors <- c("grey10", "black")
fill_vals <- c("grey90", "darkviolet")

p <- table1 %>% 
  ggplot(aes(x = forcats::fct_rev(noise_condition), y = rt, 
             color = shift_accuracy, fill = shift_accuracy)) +
  ggbeeswarm::geom_quasirandom(shape = 21) + 
  scale_color_manual(values = acc_colors) +
  scale_fill_manual(values = fill_vals) +
  labs(y = "RT (sec)", x = NULL) +
  theme_bw() +
  theme(legend.position = "right") + 
  theme(axis.title.x = element_text(size = 16, 
                                    face = "bold"), 
        axis.title.y = element_text(size = 16, 
                                    face = "bold"), axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)) +
  coord_flip()

p
```

### Accuracy plots

```{r}
ss.acc <- table1.analysis %>% 
  group_by(subid_short, noise_condition, shift_accuracy) %>% 
  summarise(n_trials = n()) %>%
  ungroup %>% 
  tidyr::complete(noise_condition, nesting(subid_short, shift_accuracy), 
           fill = list(n_trials = 0))

ss.acc %<>%
  group_by(subid_short, noise_condition) %>% 
  mutate(n_total_trials = sum(n_trials),
         prop = n_trials / n_total_trials)
```

```{r}
ss.acc %>% 
  filter(shift_accuracy == "correct") %>% 
  ggplot(aes(x = noise_condition, y = prop)) + 
  geom_boxplot(width = 0.3) +
  geom_jitter(alpha = 0.4, width = 0.05) +
  ylim(0,1) +
  geom_hline(yintercept = 0.5, linetype == "dashed") +
  theme_bw()
```

## Block analysis

Let's take a look at block effects. First, we create a variable to store information about block. We konw that trials 1-16 are block 1 and 17-32 are block 2. 

```{r}
table1.analysis <- table1.analysis %>% 
  mutate(block = ifelse(tr.num <= 16, "block_1", "block_2"))
```

Now, let's plot RT as a function of block

```{r}
ss.rt.block <- table1.analysis %>% 
  group_by(subid, noise_condition, shift_accuracy, block) %>% 
  summarise(m_rt = mean(rt))
```

```{r}
ss.rt.block %>% 
  ggplot(aes(x = noise_condition, y = m_rt, fill = shift_accuracy)) + 
  geom_boxplot() +
  facet_wrap(~block) +
  theme_bw()
```

Now do the same thing for accuracy

```{r}
ss.acc.block <- table1.analysis %>% 
  group_by(subid_short, noise_condition, shift_accuracy, block) %>% 
  summarise(n_trials = n()) %>%
  ungroup %>% 
  tidyr::complete(noise_condition, nesting(subid_short, shift_accuracy, block), 
           fill = list(n_trials = 0))

ss.acc.block %<>%
  group_by(subid_short, noise_condition, block) %>% 
  mutate(n_total_trials = sum(n_trials),
         prop = n_trials / n_total_trials)
```

Plot accuracy by block

```{r}
ss.acc.block %>% 
  filter(shift_accuracy == "correct") %>% 
  ggplot(aes(x = noise_condition, y = prop)) + 
  geom_boxplot(width = 0.3) +
  geom_jitter(alpha = 0.4, width = 0.05) +
  ylim(0,1) +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  theme_bw() +
  facet_wrap(~block)
```

Plot RT by block

```{r}
ss.rt.block %>% 
  filter(shift_accuracy == "correct") %>% 
  ggplot(aes(x = noise_condition, y = m_rt)) + 
  geom_boxplot(width = 0.3) +
  geom_jitter(alpha = 0.4, width = 0.05) +
  ylim(0,1.5) +
  theme_bw() +
  facet_wrap(~block)
```

## Statistical models

We can talk more about this aspect of the anlaysis once you made some progress on data viz. 

```{r}
table1.model <- table1.analysis %>% mutate(correct = ifelse(shift_accuracy == "correct", 1, 0))

m1 <- glmer(correct ~ noise_condition + (noise_condition|subid_short), 
      data = table1.model,
      family = "binomial")
```



