---
title: "Speed-Acc Trio BDA"
author: "Kyle MacDonald"
output: html_document
---

## Setup

This document contains the codebase for the bayesian data analysis in Experiment 1 of the paper, "An information-seeking account of children's eye movements during grounded signed and spoken language comprehension."

```{r set global_options, include=FALSE}
library(here)
source(here::here("R/helper_functions/libraries_and_functions.R"))
source(here::here("R/helper_functions/ewma_helper_funs.R"))

data_path <- "data/3_final_merged_data/first_shifts/"
ewma_path <- "data/3_final_merged_data/ewma_output/"
hddm_path <- "data/3_final_merged_data/hddm_output/"

options(mc.cores=parallel::detectCores())
set.seed (3875)
```

## Read data

```{r read_data}
df <- read_csv(here::here(data_path, "speed-acc-child-trio-fst-shift.csv"))

df %<>% 
  mutate(stimuli = ifelse(stimuli == "V1" | stimuli == "V2", "ASL", 
                          ifelse(stimuli == "Trio", "Object", 
                                 ifelse(stimuli == "Bull", "Bullseye",
                                        stimuli))),
         stimuli = factor(stimuli, levels = c("ASL", "Face", "Object", "Bullseye")))

df %<>% mutate(log_rt = log(RT))
```

```{r set global analysis params}
upper_bound_RT <- 2000
```

```{r}
df %<>% filter(RT <= upper_bound_RT)
```

### Accuracy models

First, we fit the model for child participants only, including age as a continous variable. 

```{r fit continuous age acc model}
m_acc_contin <- df %>% 
  filter(age_code == "child") %>% 
  stan_glmer(correct ~ stimuli + Months + (1 | Sub.Num) + (1 | clean_target_img), 
  data = .,
  family = binomial(link = "logit"), 
  prior = normal(0, 2),
  prior_intercept = normal(0, 1),
  prior_covariance = decov(regularization = 2), 
  adapt_delta = 0.99,
  chains = 4)

samples_trio_acc_contin <- m_acc_contin %>% 
  as.data.frame() %>% as_tibble() %>% 
  dplyr::rename(asl = `(Intercept)`,
                face = stimuliFace,
                object = stimuliObject,
                bullseye = stimuliBullseye,
                age_beta = Months) %>% 
  select(asl:age_beta)
```

Next, we fit the age model including adults, treating age as a categorical variable. Note that we have adult data for just the bullseye and asl conditions in this dataset, but we could use the adult "face" condition from the text experiment. 

```{r fit categorical age acc model}
m_acc_cat <- df %>% 
  filter(stimuli %in% c("ASL", "Bullseye")) %>% 
  stan_glmer(correct ~ stimuli + age_code + (1 | Sub.Num) + (1 | clean_target_img), 
  data = .,
  family = binomial(link = "logit"), 
  prior = normal(0, 2),
  prior_intercept = normal(0, 1),
  prior_covariance = decov(regularization = 2), 
  adapt_delta = 0.99,
  chains = 4)

samples_trio_acc_cat <- m_acc_cat %>% 
  as.data.frame() %>% as_tibble() %>% 
  dplyr::rename(asl = `(Intercept)`,
                bullseye = stimuliBullseye,
                age_beta_child = age_codechild) %>% 
  select(asl:age_beta_child)
```

### RT models

```{r fit age continous rt model}
m_rt_contin <-  df %>% 
  filter(age_code == "child", correct == 1) %>% 
  stan_glmer(log_rt ~ stimuli + Months + (1 | Sub.Num) + (1 | clean_target_img), 
  family = gaussian(),
  data = .,
  prior = normal(0, 2), 
  prior_intercept = normal(0, 5),
  prior_covariance = decov(regularization = 2), # prior on Covariance matrices for mixed effects model
  chains = 4)

samples_trio_rt_contin <- m_rt_contin %>% 
  as.data.frame() %>% as_tibble() %>% 
  dplyr::rename(asl = `(Intercept)`,
                face = stimuliFace,
                object = stimuliObject,
                bullseye = stimuliBullseye,
                age_beta = Months) %>% 
  select(asl:age_beta)
```

```{r}
m_rt_cat <-  df %>% 
  filter(stimuli %in% c("ASL", "Bullseye")) %>% 
  stan_glmer(log_rt ~ stimuli + age_code + (1 | Sub.Num) + (1 | clean_target_img), 
  family = gaussian(),
  data = .,
  prior = normal(0, 2), 
  prior_intercept = normal(0, 5),
  prior_covariance = decov(regularization = 2), # prior on Covariance matrices for mixed effects model
  chains = 4)

samples_trio_rt_cat <- m_rt_cat %>% 
  as.data.frame() %>% as_tibble() %>% 
  dplyr::rename(asl = `(Intercept)`,
                bullseye = stimuliBullseye,
                age_beta_child = age_codechild) %>% 
  select(asl:age_beta_child)
```

### EWMA

```{r read ewma output noise}
trio_ewma <- c("speed_acc_kids_trio_ewma_results.csv")
d_ewma_trio <- trio_ewma %>% purrr::map_df(read_ewma, path = ewma_path) 
```

#### Cutoff points

```{r}
# Aggregate cutoffs for each participant
ss_cutoffs <- d_ewma_trio %>% 
  filter(guess == "response") %>% 
  group_by(stimuli, subid, months) %>% 
  summarise_(cutoff = interp(~ min(x), x = as.name("rt")))
```

```{r}
m_ewma_trio <- ss_cutoffs %>% 
  filter(stimuli %in% c("ASL", "Face")) %>% 
  stan_lm(cutoff ~ stimuli, data = ., prior = R2(0.75, what = 'mean'),
          chains = 4, 
          adapt_delta = 0.99)

samples_trio_ewma_cuts <- m_ewma_trio %>% 
  as.data.frame() %>% as_tibble() %>% 
  dplyr::rename(asl = `(Intercept)`,
                face = stimuliFace) %>% 
  select(asl:face)
```

#### Prop Guessing

```{r}
m_ewma_trio_guess <- d_ewma_trio %>% 
  filter(age_code == "child", stimuli %in% c("ASL", "Face")) %>% 
  stan_glmer(guess_num ~ stimuli + months + (1|subid),
        data = .,
        family = binomial(link = "logit"), 
        prior = normal(0, 2),
        prior_intercept = normal(0, 1),
        prior_covariance = decov(regularization = 2), 
        adapt_delta = 0.99,
        chains = 4)

samples_trio_ewma_guess <- m_ewma_trio_guess %>% 
  as.data.frame() %>% as_tibble() %>% 
  dplyr::rename(asl = `(Intercept)`,
                face = stimuliFace,
                age_beta = months) %>% 
  select(asl:face, age_beta)
```

## Save posterior samples

```{r}
posteriors <- list(rt_trio_contin = samples_trio_rt_contin,
                   rt_trio_cat = samples_trio_rt_cat,
                   acc_trio_contin = samples_trio_acc_contin,
                   acc_trio_cat = samples_trio_acc_cat,
                   ewma_guess_trio = samples_trio_ewma_guess,
                   ewma_cuts_trio = samples_trio_ewma_cuts)

saveRDS(posteriors, file = here::here(data_path, "speed-acc-trio-posterior-samples.rds"))
```

