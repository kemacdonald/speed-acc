---
title: "Speed-Acc Statistical Models"
output: html_document
---

## Setup

```{r set global_options, include=FALSE}
library(here)
source(here::here("R/helper_functions/libraries_and_functions.R"))
data_path <- "data/3_final_merged_data/first_shifts/"
```

```{r read data}
d_kids_noise <- read_csv(here::here(data_path, "speed_acc_child_noise_fstshift_tidy.csv")) 
d_kids_gaze <- read_csv(here::here(data_path, "speed_acc_child_gaze_fstshift_tidy.csv")) 
d_adults <- read_csv(here::here(data_path, "speed_acc_adult_ng_fstshift_tidy.csv")) 
```

## Merge datasets

```{r clean datasets for merge}
d_adults %<>% select(-age)

d_kids_noise %<>% mutate(gaze_condition = ifelse(gaze_condition == "no_gaze", 
                                                 "straight_ahead", 
                                                 gaze_condition))

d_kids_gaze %<>% mutate(noise_condition = ifelse(noise_condition == "no_noise", 
                                                 "clear", 
                                                 noise_condition))
```

```{r merge datasets}
d <- bind_rows(mutate(d_kids_noise, experiment = "kids_noise", age_category = "children"),
               mutate(d_kids_gaze, experiment = "kids_gaze", age_category = "children"),
               mutate(d_adults, experiment = "adults_ng", age_category = "adults")) %>% 
  select(-resp_onset_type_fact, -subid_short) %>% 
  mutate(age_category = factor(age_category) %>% fct_rev()) 

# uncomment below to test that we have the right number of rows after the merge (result should be TRUE)
# nrow(d_kids_gaze) + nrow(d_kids_noise) + nrow(d_adults) == nrow(d)
```

## Noise experiment (RT and Accuracy models)

```{r e1_filter}
d_e1_analysis <- d %>% 
  filter(experiment != "kids_gaze",
         keep_runsheet %in% c("yes", "keep"), 
         keep_et == "include",
         gaze_condition == "straight_ahead") %>% 
  filter(rt <= 1.5,
         response_onset_type == "noun", 
         shift_start_location == "center") %>% 
  mutate(shift_acc_num = ifelse(shift_accuracy_clean == "correct", 1, 0),
         log_rt = log(rt))
```

### Accuracy (Noise)

```{r acc noise model}
m_bglm_acc_e1 <- stan_glmer(
  shift_acc_num ~ noise_condition + age_category + (noise_condition + target_image | subid), 
  data = d_e1_analysis,
  family = binomial(link = "logit"), 
  prior = normal(0, 2),
  prior_intercept = normal(0, 1),
  prior_covariance = decov(regularization = 2), # prior on Covariance matrices for mixed effects model
  chains = 4
)
```

### RT (Noise)

```{r rt noise model}
m_bglm_rt_e1 <- stan_glmer(
  log_rt ~ noise_condition + age_category + (noise_condition + target_image | subid), 
  family = gaussian(),
  data = d_e1_analysis,
  prior = normal(0, 2), 
  prior_intercept = normal(0, 5),
  prior_covariance = decov(regularization = 2), # prior on Covariance matrices for mixed effects model
  chains = 4
)
```

Extract posterior samples from both models.

```{r e1 extract posterior samples}
# get posterior samples
samples_e1_acc <- m_bglm_acc_e1 %>% 
  as.data.frame() %>% 
  as_tibble() %>% 
  dplyr::rename(clear_children = `(Intercept)`,
                noise_beta = noise_conditionnoise,
                age_beta = age_categoryadults) %>% 
  select(clear_children, noise_beta, age_beta)

samples_e1_rt <- m_bglm_rt_e1 %>% 
  as.data.frame() %>% 
  as_tibble() %>% 
  dplyr::rename(clear_children = `(Intercept)`,
                noise_beta = noise_conditionnoise,
                age_beta = age_categoryadults) %>% 
  select(clear_children, noise_beta, age_beta)

# tidy up accuracy
samples_e1_acc_tidy <- samples_e1_acc %>% 
  mutate(noise_children = clear_children + noise_beta,
         clear_adults = clear_children + age_beta, 
         noise_adults = clear_children + noise_beta + age_beta,
         sample_id = 1:n()) %>% 
  gather(key = condition, value = param_est, -sample_id, -noise_beta, -age_beta) %>% 
  mutate(acc_prob_scale = logit_to_prob(param_est)) %>% 
  separate(condition, into = c("noise_condition", "age_category"))

# tidy up rt samples
samples_e1_rt_tidy <- samples_e1_rt %>% 
  mutate(noise_children = clear_children + noise_beta,
         clear_adults = clear_children + age_beta, 
         noise_adults = clear_children + noise_beta + age_beta,
         sample_id = 1:n()) %>% 
  gather(key = condition, value = param_est, -sample_id, -noise_beta, -age_beta) %>% 
  mutate(rt_ms_scale = exp(param_est)) %>% 
  separate(condition, into = c("noise_condition", "age_category")) 
```

## Gaze experiment (RT and Accuracy models)

```{r get gaze experiment}
d_e2 <- d %>% 
  filter(experiment != "kids_gaze",
         keep_runsheet %in% c("yes", "keep"), 
         keep_et == "include",
         noise_condition == "clear")
```

```{r filter gaze participants}
d_e2_analysis <- d_e2 %>% 
  filter(rt <= 2,
         response_onset_type == "noun",
         shift_start_location == "center") %>% 
  mutate(shift_acc_num = ifelse(shift_accuracy_clean == "correct", 1, 0),
         log_rt = log(rt))
```

### Accuracy (Gaze)

```{r acc gaze model}
m_bglm_acc_e2 <- stan_glmer(
  shift_acc_num ~ gaze_condition + age_category + (gaze_condition + target_image | subid), 
  data = d_e2_analysis,
  family = binomial(link = "logit"), 
  prior = normal(0, 2),
  prior_intercept = normal(0, 1),
  prior_covariance = decov(regularization = 2),
  chains = 4
)
```

### RT (Gaze)

```{r rt gaze model}
m_bglm_rt_e2 <- stan_glmer(
  log_rt ~ gaze_condition + age_category + (gaze_condition + target_image | subid), 
  family = gaussian(),
  data = d_e2_analysis,
  prior = normal(0, 2), 
  prior_intercept = normal(0, 5),
  prior_covariance = decov(regularization = 2),
  chains = 4
)
```

### Extract posterior samples gaze experiment

```{r gaze model extract posterior samples}
# get posterior samples
samples_e2_acc <- m_bglm_acc_e2 %>% 
  as.data.frame() %>% 
  as_tibble() %>% 
  dplyr::rename(gaze_children = `(Intercept)`,
                straightahead_beta = gaze_conditionstraight_ahead,
                age_beta = age_categoryadults) %>% 
  select(gaze_children, straightahead_beta, age_beta)

samples_e2_rt <- m_bglm_rt_e2 %>% 
  as.data.frame() %>% 
  as_tibble() %>% 
  dplyr::rename(gaze_children = `(Intercept)`,
                straightahead_beta = gaze_conditionstraight_ahead,
                age_beta = age_categoryadults) %>% 
  select(gaze_children, straightahead_beta, age_beta)

# tidy up accuracy
samples_e2_acc_tidy <- samples_e2_acc %>% 
  mutate(straightahead_children = gaze_children + straightahead_beta,
         straightahead_adults = gaze_children + age_beta + straightahead_beta, 
         gaze_adults = gaze_children + age_beta,
         sample_id = 1:n()) %>% 
  gather(key = condition, value = param_est, -sample_id, -straightahead_beta, -age_beta) %>% 
  mutate(acc_prob_scale = logit_to_prob(param_est)) %>% 
  separate(condition, into = c("gaze_condition", "age_category"))

# tidy up rt samples
samples_e2_rt_tidy <- samples_e2_rt %>% 
    mutate(straightahead_children = gaze_children + straightahead_beta,
         straightahead_adults = gaze_children + age_beta + straightahead_beta, 
         gaze_adults = gaze_children + age_beta,
         sample_id = 1:n()) %>% 
  gather(key = condition, value = param_est, -sample_id, -straightahead_beta, -age_beta) %>% 
  mutate(rt_ms_scale = exp(param_est)) %>% 
  separate(condition, into = c("gaze_condition", "age_category"))
```

Plot parameter estimates

```{r}
samples_e2_acc_tidy %>% ggplot(aes(x=logit_to_prob(param_est), color = gaze_condition)) +
  geom_line(stat = "density") +
  facet_wrap(~age_category)
```

```{r}
samples_e2_rt_tidy %>% ggplot(aes(x=exp(param_est), color = gaze_condition)) +
  geom_line(stat = "density") +
  facet_wrap(~age_category)
```

## EWMA analysis models

Read in EWMA output. 

```{r read ewma output}
noise_ewma_files <- c("speed_acc_kids_noise_ewma_results.csv",
                      "speed_acc_adult_ng_ewma_results.csv")

d_ewma_noise <- noise_ewma_files %>% 
  purrr::map_df(read_ewma, path = ewma_path) 
```

Filter to select just the noise and clear conditions.

```{r filter ewma results noise}
d_ewma_noise %<>% 
  filter(experiment %in% c("noise", "noise_gaze"),
         condition %in% c("clear", 
                          "noise", 
                          "straight_ahead_noise", 
                          "straight_ahead_clear")) %>% 
  mutate(noise_condition = ifelse(str_detect(condition, "noise"), "noise", "clear"),
         age_category = ifelse(age_code == "child", "children", "adults")) 
```

### EWMA cut point model (Noise)

```{r aggregate cutpoints ewma noise}
ss_cutoffs_noise <- d_ewma_noise %>% 
  filter(guess == "response") %>% 
  group_by(subid, noise_condition, age_category) %>% 
  summarise_(cutoff = interp(~ min(x), x = as.name("rt"))) %>% 
  mutate(log_cut = log(cutoff))

# fit model
m_cutoffs <- stan_lm(cutoff ~ noise_condition + age_category, 
                     data = ss_cutoffs_noise,
                     prior = R2(0.75, what = "mean"))

# get posterior samples
samples_ewma_cuts_noise <- m_cutoffs %>% 
  as.data.frame() %>% 
  as_tibble() %>% 
  dplyr::rename(clear_adults = `(Intercept)`,
                noise_beta = noise_conditionnoise,
                age_beta = age_categorychildren) %>% 
  select(clear_adults, noise_beta, age_beta) %>% 
  mutate(clear_children = clear_adults + noise_beta,
         noise_children = clear_adults + age_beta + noise_beta, 
         noise_adults = clear_adults + noise_beta,
         sample_id = 1:n()) %>% 
  gather(key = condition, value = param_est, -sample_id, -noise_beta, -age_beta) %>% 
  separate(condition, into = c("noise_condition", "age_category"))
```

### EWMA guessing model (Noise)

```{r aggregate prop guessing ewma}
# fit model
m_guessing_noise <- stan_glmer(
  guess_num ~ noise_condition + age_category + (noise_condition | subid),
  data = d_ewma_noise,
  prior = normal(0, 2),
  prior_intercept = normal(0, 1),
  prior_covariance = decov(regularization = 2), 
  chains = 4
)

# get posterior samples
samples_ewma_guess_noise <- m_guessing_noise %>% 
  as.data.frame() %>% 
  as_tibble() %>% 
  dplyr::rename(clear_adults = `(Intercept)`,
                noise_beta = noise_conditionnoise,
                age_beta = age_categorychildren) %>% 
  select(clear_adults, noise_beta, age_beta) %>% 
  mutate(clear_children = clear_adults + age_beta,
         noise_children = clear_adults + age_beta + noise_beta, 
         noise_adults = clear_adults + noise_beta,
         sample_id = 1:n()) %>% 
  gather(key = condition, value = param_est, -sample_id, -noise_beta, -age_beta) %>% 
  separate(condition, into = c("noise_condition", "age_category"))
```

### EWMA cut point model (Gaze)

Read in EWMA output. 

```{r read ewma output}
gaze_ewma_files <- c("speed_acc_kids_gaze_ewma_results.csv",
                      "speed_acc_adult_ng_ewma_results.csv")

d_ewma_gaze <- gaze_ewma_files %>% 
  purrr::map_df(read_ewma, path = ewma_path) 
```

Filter to select just the noise and clear conditions.

```{r filter ewma results noise}
d_ewma_gaze %<>% 
  filter(experiment %in% c("gaze", "noise_gaze"),
         condition %in% c("gaze", 
                          "straight_ahead", 
                          "gaze_clear", 
                          "straight_ahead_clear")) %>% 
  mutate(gaze_condition = ifelse(str_detect(condition, "gaze"), "gaze", "straight_ahead"),
         age_category = ifelse(age_code == "child", "children", "adults")) 
```

```{r cutpoints model gaze}
ss_cutoffs_gaze <- d_ewma_gaze %>% 
  filter(guess == "response") %>% 
  group_by(subid, gaze_condition, age_category) %>% 
  summarise_(cutoff = interp(~ min(x), x = as.name("rt"))) %>% 
  mutate(log_cut = log(cutoff))

# fit model
m_cutoffs_gaze <- stan_lm(cutoff ~ gaze_condition + age_category, 
                          data = ss_cutoffs_gaze,
                          prior = R2(0.75, what = "mean"))

# get posterior samples
samples_ewma_cuts_gaze <- m_cutoffs_gaze %>% 
  as.data.frame() %>% 
  as_tibble() %>% 
  dplyr::rename(gaze_adults = `(Intercept)`,
                straightahead_beta = gaze_conditionstraight_ahead,
                age_beta = age_categorychildren) %>% 
  select(gaze_adults, straightahead_beta, age_beta) %>% 
  mutate(gaze_children = gaze_adults + age_beta,
         straightahead_children = gaze_children + age_beta + straightahead_beta, 
         straightahead_adults = gaze_adults + straightahead_beta,
         sample_id = 1:n()) %>% 
  gather(key = condition, value = param_est, -sample_id, -straightahead_beta, -age_beta)
```

```{r}
samples_ewma_cuts_gaze %>% ggplot(aes(x=param_est, color = condition)) +
  geom_line(stat = "density") 
```

### EWMA guessing model (Gaze)

```{r}
# fit model
m_guessing_gaze <- stan_glmer(
  guess_num ~ gaze_condition + age_category + (gaze_condition | subid),
  data = d_ewma_gaze,
  prior = normal(0, 2),
  prior_intercept = normal(0, 1),
  prior_covariance = decov(regularization = 2), 
  chains = 4
)

# get posterior samples
samples_ewma_guess_gaze <- m_guessing_gaze %>% 
  as.data.frame() %>% 
  as_tibble() %>% 
  dplyr::rename(gaze_adults = `(Intercept)`,
                straightahead_beta = gaze_conditionstraight_ahead,
                age_beta = age_categorychildren) %>% 
  select(gaze_adults, straightahead_beta, age_beta) %>% 
  mutate(gaze_children = gaze_adults + age_beta,
         straightahead_children = gaze_adults + age_beta + straightahead_beta, 
         straightahead_adults = gaze_adults + straightahead_beta,
         sample_id = 1:n()) %>% 
  gather(key = condition, value = param_est, -sample_id, -straightahead_beta, -age_beta)
```

```{r}
samples_ewma_guess_gaze %>% ggplot(aes(x=param_est, color = condition)) +
  geom_line(stat = "density") 
```

## Save the posterior samples 

For later analysis and visualization.

```{r}
posteriors <- list(rt_noise = samples_e1_rt_tidy,
                   acc_noise = samples_e1_acc_tidy,
                   rt_gaze = samples_e2_rt_tidy,
                   acc_gaze = samples_e2_acc_tidy,
                   ewma_cuts_noise = samples_ewma_cuts_noise,
                   ewma_guess_noise = samples_ewma_guess_noise,
                   ewma_cuts_gaze = samples_ewma_cuts_gaze,
                   ewma_guess_gaze = samples_ewma_guess_gaze)

saveRDS(posteriors, file = here::here("data/3_final_merged_data/first_shifts",
                                      "speed-acc-posterior-samples.rds"))

beepr::beep(sound = 3)
```