---
title: "Speed-Acc-Child Noise first shift analysis"
author: "Hannah Slater and Kyle MacDonald"
output: html_document
---

## Set up 

```{r chunk_options, echo = F}
# code to clear workspace
rm(list=ls()) 

# set some global options
knitr::opts_chunk$set(warning=F, message=F, sanitize = T, 
                      fig.height=5, fig.width=8, echo=T, cache = F)
```

read in personal library of helper functions

```{r}
source("../../helper_functions/libraries_and_functions.R")
theme_set(ggthemes::theme_few())
```

## Load data

```{r}
d <- read_csv("../../../data/3_final_merged_data/first_shifts/speed_acc_child_noise_fstshift_tidy.csv")
```

## Check the data

How many participants in the dataset?  

```{r}
d %>% distinct(subid_short) %>% count() %>% kable()
```

How many trials do we have for each participant?

```{r}
d %>% 
  select(subid_short, tr.num) %>% 
  unique() %>% 
  group_by(subid_short) %>%
  count() %>% 
  kable()
```

Not every participant has the same number of trials, but no participant has more than 32 trials, which is good.

How many trials does each participoant have in each condition? 

```{r}
trials_df <- d %>% 
  filter(!(is.na(rt))) %>% 
  select(subid_short, tr.num, noise_condition) %>% 
  unique() %>% 
  group_by(subid_short, noise_condition) %>%
  count() 

# add this information to the rest of the data
d %<>% left_join(., trials_df, by = c("subid_short", "noise_condition"))

trials_df %>% kable()
```

What's the average number of trials for each condition?

```{r}
d %>% 
  filter(!(is.na(rt))) %>% 
  select(subid_short, noise_condition, tr.num) %>% 
  unique() %>% 
  group_by(subid_short, noise_condition) %>% 
  summarise(n = n()) %>% 
  group_by(noise_condition) %>% 
  summarise(avg_trials = mean(n) %>% round(digits = 2))
```

Let's visualize it just to be sure there's no difference in attrition.

```{r}
d %>% 
  filter(!(is.na(rt))) %>% 
  select(subid_short, noise_condition, tr.num) %>% 
  unique() %>% 
  group_by(subid_short, noise_condition) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = n, color = noise_condition)) +
  geom_freqpoly() +
  geom_vline(xintercept = 8, linetype = "dashed")
```

The distribution of trials completed looks pretty similar across conditions, which is nice. 

## Data filtering

Remove shifts that do not start at center, participant exclusions, and extreme RTs

```{r}
d.analysis <- d %>% 
  filter(!(is.na(shift_accuracy_clean)),
         response_onset_type == "noun",
         keep_et == "include",
         keep_runsheet == "keep",
         rt <= 1.5) 
```

## Explore data via visualization

What does the distribution of age in the sample look like? 

```{r}
d.analysis %>% 
  select(subid_short, age_group) %>% 
  unique() %>% 
  ggplot(aes(x = as.factor(age_group))) +
  geom_histogram(stat = 'count')
```

Plot the distribution of Reaction Times (RT)

```{r}
d.analysis %>% 
  filter(shift_start_location == "center") %>% 
  ggplot() + 
  geom_density(mapping = aes(x = rt, fill = noise_condition), 
               alpha = 0.5, binwidth = 0.05, position = "identity", 
               adjust = 2) +
  facet_grid(shift_accuracy_clean~block)
```

## Aggregated visualizations

Aggregate RT

```{r}
ss.rt <- d.analysis %>% 
  filter(shift_start_location == "center") %>% 
  group_by(subid_short, noise_condition, shift_accuracy_clean, block) %>% 
  summarise(m_rt = median(rt, na.rm = T)) 
```

RT boxplot

```{r}
ss.rt %>% 
  ggplot(mapping = aes(x = noise_condition, y = m_rt, fill = shift_accuracy_clean)) +
  geom_boxplot(width = 0.3) +
  theme(legend.position = "right") + 
  theme(axis.title.x = element_text(size = 16, face = "bold"), 
        axis.title.y = element_text(size = 16, face = "bold"), 
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)) + 
  scale_y_continuous(limits=c(0,1)) + 
  labs(y = "reaction time", x = "condition") + 
  facet_wrap(~block)
```

Now plot RT as a function of correct or incorrect shifts, collapsing across blocks.

```{r}
ss.rt %>% 
  ggplot(aes(x = noise_condition, y = m_rt, fill = shift_accuracy_clean)) + 
  geom_boxplot() +
  scale_y_continuous(limits=c(0,0.8)) + 
  labs(y = "reaction time") 
```

Let's try visualizing RT distributions using beeswarm plot to see if the shape of the RT distributions look different across the noise conditions.

```{r}
acc_colors <- c("grey10", "black")
fill_vals <- c("#F8766D", "#00BFC4")

d.analysis %>% 
  ggplot(aes(x = forcats::fct_rev(noise_condition), y = rt, 
             color = shift_accuracy_clean, fill = shift_accuracy_clean)) +
  ggbeeswarm::geom_quasirandom(shape = 21) + 
  scale_color_manual(values = acc_colors) +
  scale_fill_manual(values = fill_vals) +
  labs(y = "RT (sec)", x = NULL) +
  #facet_wrap(~block, ncol = 1) +
  theme(legend.position = "right") + 
  theme(axis.title.x = element_text(size = 16, 
                                    face = "bold"), 
        axis.title.y = element_text(size = 16, 
                                    face = "bold"), axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)) +
  coord_flip()
```

### Aggregate Accuracy

```{r}
ss.acc <- d.analysis %>% 
  filter(shift_start_location == "center") %>% 
  group_by(noise_condition, subid_short, shift_accuracy_clean, block) %>% 
  summarise(n = n()) %>% 
  group_by(subid_short, noise_condition) %>% 
  mutate(total_trials = sum(n),
         prop = round(n / total_trials, 2)) 
```

Now make accuracy boxplot

```{r}
ss.acc %>% 
  filter(shift_accuracy_clean == "correct") %>% 
  ggplot() + 
  geom_boxplot(mapping = aes(x = noise_condition, y = prop), 
               fill = ("#F8766D"), width = 0.3) +
  theme(axis.title.x = element_text(size = 16, face = "bold"), 
        axis.title.y = element_text(size = 16, face = "bold"), 
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)) +
  scale_y_continuous(limits=c(0,1)) + 
  labs(y = "shift accuracy") +
  facet_wrap(~block)
```

## Statistical models

```{r}
d.model <- d.analysis %>% 
  filter(shift_start_location == "center") %>% 
  mutate(correct = ifelse(shift_accuracy_clean == "correct", 1, 0))
```

Accuracy model

```{r}
m1.acc <- glmer(correct ~ noise_condition * block + (noise_condition|subid_short) + (1|target_image), 
                data = d.model,
                family = "binomial")

summary(m1.acc)
```

RT model

```{r}
m1.rt  <- lmer(log(rt) ~ noise_condition * block + (noise_condition|subid_short) + (1|target_image), 
               data = d.model)

summary(m1.rt)
```
